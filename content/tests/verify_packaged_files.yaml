title: Verify packaged files
blocks:
- id: collect/invalid_packaged_files
  type: probe
- id: invalid_files_as_list
  title: '...'
  type: filter
  kind: cel
  sources:
  - '@collect'
  properties:
    expression: arguments.objects.map(element, element.name)
    arguments:
      objects: '@1'
- id: collect_invalid_packages_names
  title: '...'
  type: probe
  kind: process_output
  sources:
  - invalid_files_as_list
  properties:
    executable: /usr/bin/rpm
    arguments: ["-qf", "@1", "--qf", '\{"package": "%{name}", "files": \[ ""[,"%{filenames}"] \]\}\n']
  wrapper:
    json_seq: {}
- id: compose_findings
  title: '...'
  type: filter
  kind: cel
  sources:
  - '@collect'
  - collect_invalid_packages_names
  properties:
    expression: 'arguments.files.map(el, {"verify_bits": el.verify_bits, "file": el.name, "package": arguments.packages.filter(m, el.name in m.files[0].package})'
    arguments:
      files: '@1'
      packages: '@2'
- id: /any_exist
  type: filter
  sources:
  - compose_findings
